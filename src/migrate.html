<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migrate LocalStorage Data</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #000;
      color: #fff;
    }
    .btn {
      background: #ff4500;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    .btn:hover {
      background: #ff6b00;
    }
    #status {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    .success { color: #10b981; }
    .error { color: #dc2626; }
    pre {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Migrate LocalStorage Data to Database</h1>
  <p>This tool will migrate your old localStorage data to the new cloud database.</p>

  <div>
    <button class="btn" onclick="checkOldData()">1. Check Old Data</button>
    <button class="btn" onclick="migrateData()">2. Migrate to Database</button>
    <button class="btn" onclick="clearOldData()">3. Clear Old Data (after migration)</button>
  </div>

  <div id="status"></div>

  <script>
    function checkOldData() {
      const status = document.getElementById('status');
      const entries = [];

      // Check for old localStorage entries
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('tracker-') && key !== 'tracker-settings') {
          const data = localStorage.getItem(key);
          entries.push({ key, data: JSON.parse(data) });
        }
      }

      if (entries.length === 0) {
        status.innerHTML = '<p class="error">No old localStorage data found.</p>';
      } else {
        status.innerHTML = `
          <p class="success">Found ${entries.length} old entries in localStorage:</p>
          <pre>${JSON.stringify(entries, null, 2)}</pre>
        `;
      }
    }

    async function migrateData() {
      const status = document.getElementById('status');
      status.innerHTML = '<p>Migrating data...</p>';

      const entries = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('tracker-') && key !== 'tracker-settings') {
          const data = JSON.parse(localStorage.getItem(key));
          entries.push(data);
        }
      }

      if (entries.length === 0) {
        status.innerHTML = '<p class="error">No data to migrate.</p>';
        return;
      }

      let migrated = 0;
      let failed = 0;

      for (const entry of entries) {
        try {
          const response = await fetch('/api/entries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(entry)
          });

          if (response.ok) {
            migrated++;
          } else {
            failed++;
            console.error('Failed to migrate entry:', entry, await response.text());
          }
        } catch (error) {
          failed++;
          console.error('Error migrating entry:', entry, error);
        }
      }

      status.innerHTML = `
        <p class="success">Migration complete!</p>
        <p>✅ Migrated: ${migrated} entries</p>
        <p>❌ Failed: ${failed} entries</p>
        <p><strong>Next step:</strong> Go to <a href="/" style="color: #ff4500;">Calendar</a> or <a href="/charts.html" style="color: #ff4500;">Charts</a> to verify your data.</p>
      `;
    }

    function clearOldData() {
      if (!confirm('Are you sure? This will delete all localStorage data. Only do this AFTER verifying migration was successful!')) {
        return;
      }

      const status = document.getElementById('status');
      const keys = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('tracker-')) {
          keys.push(key);
        }
      }

      keys.forEach(key => localStorage.removeItem(key));

      status.innerHTML = `
        <p class="success">Cleared ${keys.length} localStorage items.</p>
      `;
    }
  </script>
</body>
</html>
